

# Moya?
ğŸ”— [Moya Github ë°”ë¡œê°€ê¸°](https://github.com/Moya/Moya)
URLSessionì„ ì¶”ìƒí™”í•˜ì—¬ í¸ë¦¬í•˜ê²Œ ë§Œë“¤ì–´ì¤€ ê²ƒì´ Alamofireë¼ë©´, ì´ë¥¼ í•œ ë²ˆ ë” ì¶”ìƒí™” í•˜ì—¬, ê°œë°œìê°€ APIì˜ í†µì‹ ì—ì„œ request, responseì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ê²ƒì´ ë°”ë¡œ Moyaë¼ê³  í•  ìˆ˜ ìˆë‹¤!

# Moya ì‹œì‘í•˜ê¸°
ì‹œì‘í•˜ê¸°ì— ì•ì„œ, MoyaëŠ” ì—´ê±°í˜•`enum`ì„ í™œìš©í•œë‹¤ëŠ” íŠ¹ì§•ì´ ìˆë‹¤. ì´ë¥¼ í†µí•´ì„œ ë„¤íŠ¸ì›Œí¬ë¥¼ ìš”ì²­í•˜ëŠ” íƒ€ì…ì„ ë³´ë‹¤ ì•ˆì „í•˜ê²Œ ìº¡ìŠí™”í•´ì„œ ì‚¬ìš©í•˜ëŠ” ë°ì— ì´ˆì ì„ ë§ì¶”ê³  ìˆëŠ” ë„¤íŠ¸ì›Œí‚¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¼ê³  í•  ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ ì•ìœ¼ë¡œ ì‘ì„±í•˜ëŠ” ì½”ë“œë“¤ ì—­ì‹œ enumê³¼ `dot syntax`ë¥¼ í™œìš©í•´ì„œ ì‘ì„±í•œë‹¤ëŠ” ì ì„ ê¸°ì–µí•˜ì.

1. `API target enum` ì‘ì„±
```swit
enum QueueService {
    case requestFindHobbyFriends(param: QueueRequest)
    case onQueue(param: OnQueueRequest)
    case stopFindingHobbyFriends
}
```
ìœ„ì™€ ê°™ì´, ë§Œì•½ APIë¥¼ ìš”ì²­í•˜ë©´ì„œ í•„ìš”í•œ ë°”ë””ë‚˜ ì¿¼ë¦¬ ë“±ì˜ ë§¤ê°œë³€ìˆ˜ë“¤ì´ ìˆë‹¤ë©´, ê°™ì´ ì‘ì„±í•´ì¤€ë‹¤.
ë‚˜ì˜ ê²½ìš°ì—ëŠ” ì¡°ê¸ˆ ë” ê¹”ë”í•˜ê²Œ, ê·¸ë¦¬ê³  ë§¤ê°œë³€ìˆ˜ê°€ ì¤‘ë³µë  ë•Œì˜ ì¬ì‚¬ìš©ì„±ì„ ê³ ë ¤í•´ì„œ ë”°ë¡œ `struct`ì²˜ë¦¬ë¥¼ í•´ ì£¼ì—ˆë‹¤.
```swift
struct OnQueueRequest: Codable {
    var region: Int
    var lat: Double
    var long: Double
}
```

2. `TargetType`êµ¬í˜„
ì´ì œ extensionì„ í†µí•´ì„œ ë„¤íŠ¸ì›Œí¬ í†µì‹ ì— í•„ìš”í•œ ì†ì„±ë“¤ì„ ì‘ì„±í•´ ì¤€ë‹¤. MoyaëŠ” `MoyaProvider<TargetType>` í”„ë¡œí† ì½œì„ ì¤€ìˆ˜í•œë‹¤.
`TargetType`ì„ ì±„íƒí•˜ê³  ì˜¤ë¥˜ê°€ ìƒê²¼ì„ ë•Œ `fix`ë¥¼ ëˆ„ë¥´ë©´, ì±„ì›Œì•¼í•˜ëŠ” í”„ë¡œí¼í‹°ë“¤ì´ ë‚˜íƒ€ë‚œë‹¤.

ì´ì œ ì°¬ì°¬íˆ ì•„ë˜ì˜ `code`ë“¤ì„ ì±„ì›Œ ë‚˜ê°€ë³´ì.
- baseURL: ë§ê·¸ëŒ€ë¡œ baseURLì´ë‹¤.
```swift
  var baseURL: URL {
        return URL(string: "baseURLì‘ì„±í•´ì£¼ê¸°")!
    }
```

- path: ì„œë²„ì˜ baseURLë’¤ì— ì¶”ê°€ë  pathë¥¼ ì ì–´ì¤€ë‹¤.
```swift
var path: String {
        switch self {
        case .requestFindHobbyFriends, .stopFindingHobbyFriends:
            return "queue"
        case .onQueue:
            return "queue/onqueue"
        }
}
```
- â—ï¸method: HTTP Methodë¥¼ ì •í•´ì£¼ëŠ” ë¶€ë¶„ì´ë‹¤. ì´ ê³³ ë•Œë¬¸ì— xcodeìƒì—ì„œ ê³„ì† ë¹¨ê°„ ì˜¤ë¥˜ê°€ ëœ° ìˆ˜ ìˆëŠ”ë°, ê¸°ë³¸ìœ¼ë¡œ ì‘ì„±ë˜ëŠ” íƒ€ì…ì¸ `Method`ê°€ ì•„ë‹ˆë¼, `Moya.Method`ìœ¼ë¡œ íƒ€ì…ì„ ë°”ê¾¸ì–´ ì£¼ì–´ì•¼ í•œë‹¤ëŠ” ì ì„ ê¸°ì–µí•˜ì!
```swift
var method: Moya.Method {
        switch self {
        case .requestFindHobbyFriends, .onQueue:
            return .post
        case .stopFindingHobbyFriends:
            return .delete
        }
}
```
- task: ì—¬ê¸°ì—ì„œëŠ” API í†µì‹ ì„ í•  ë•Œ ìš”ì²­í•˜ëŠ” íŒŒë¼ë¯¸í„°ë¥¼ ì‘ì„±í•´ ì¤€ë‹¤. **í˜¹ì‹œ íŒŒë¼ë¯¸í„°ê°€ ì—†ë”ë¼ë„**, ì•„ê¹Œ ìœ„ì—ì„œ ì‘ì„±í•œ enumì— ìˆëŠ” Endpint **ëª¨ë‘**ì— ëŒ€í•´ì„œ ì‘ì„±ì„ í•´ ì£¼ì–´ì•¼ í•œë‹¤.
```swift
var task: Task {
        switch self {
        case .requestFindHobbyFriends(let param):
            return .requestParameters(parameters: [
                "type": param.type,
                "region": param.region,
                "long": param.long,
                "lat": param.lat,
                "hf": param.hf
            ], encoding: URLEncoding.default)
            
        case .onQueue(let param):
            return .requestParameters(parameters: [
                "region": param.region,
                "lat": param.lat,
                "long": param.long
            ], encoding: URLEncoding.default)
            
        case .stopFindingHobbyFriends:
            return .requestPlain
        }
}    
```
- ì¢…ë¥˜
  - `plain request`: íŒŒë¼ë¯¸í„° ì—†ëŠ” ê²½ìš°
  - `parameter request` : encoded parametersë¥¼ ë³´ë‚´ëŠ” ê²½ìš°
  - `JSONEncodable request` : Encodable typeìœ¼ë¡œ ë³´ë‚´ëŠ” ê²½ìš°
  - ê·¸ ì™¸: `data request`,`pload request`

- headers: ë§ ê·¸ëŒ€ë¡œ HTTP í—¤ë”!
```swift
 var headers: [String : String]? {
        switch self {
        default:
            return [
                "Content-Type" : "application/x-www-form-urlencoded"
            ]
        }
}
```

ğŸ™‹ ì°¸ê³ ë¡œ ë‚˜ëŠ” ìì£¼ ì‚¬ìš©ë˜ëŠ” baseURL, ê·¸ë¦¬ê³  HTTP HeaderëŠ” ë°”ë”” íŒŒë¼ë¯¸í„°ì²˜ëŸ¼ `struct`ì™€ `enum`ì„ ì‚¬ìš©í–ˆë‹¤.

ì—¬ê¸°ê¹Œì§€ ëª¨ë‘ ì‘ì„±í•˜ë©´, ë„¤íŠ¸ì›Œí¬ í†µì‹ ì— í•„ìš”í•œ ëª¨ë“  ìš”ì†Œë“¤ì„ ì‘ì„±í–ˆë‹¤. ì´ì œ ì–´ë–»ê²Œ ì‚¬ìš©í•˜ëŠ”ì§€ ì•Œì•„ë³´ì.

3. Moyaë¡œ API í†µì‹ í•˜ê¸°
```swift
static private let provider = MoyaProvider<QueueService>()
    
// .queue
static func requestFindHobbyFriends(param: QueueRequest, completion: @escaping (Friends?, APIErrorCode?) -> Void) {
        
       provider.request(.requestFindHobbyFriends(param: param)) { result in
            switch result {
            case .success(let response):
                // ì„±ê³µí–ˆì„ ë•Œ ì²˜ë¦¬í•´ì¤„ ì½”ë“œ
            case .failure(let error):
                // ì‹¤íŒ¨í–ˆì„ ë•Œ ì²˜ë¦¬í•´ì¤„ ì½”ë“œ
            }
        }
}

```
- `static private let provider = MoyaProvider<QueueService>()`
	: APIí†µì‹ ì— í•„ìš”í•œ Moyaì˜ `provider`ë¥¼ ì •ì˜í•´ì¤€ë‹¤.
- `case .success(let response):`, `case .failure(let error):`
	: í†µì‹  ì„±ê³µ ì‹œ, í˜¹ì€ ì‹¤íŒ¨ ì‹œ ì‹¤í–‰í•  ì½”ë“œë¥¼ ì‘ì„±í•´ì¤€ë‹¤.

# ë°˜ë³µë˜ëŠ” errorì— ëŒ€í•œ ì²˜ë¦¬ëŠ” ì–´ë–»ê²Œ?
APIí†µì‹ ì„ í•˜ë‹¤ë³´ë©´, 401, 500ê³¼ ê°™ì´ ë°˜ë³µë˜ëŠ” ì˜¤ë¥˜ê°€ ìˆë‹¤. ê·¸ë¦¬ê³  ë§Œë£Œëœ í† í°ì„ ë‹¤ì‹œ ë°œí–‰í•´ ì¤€ë‹¤ë˜ì§€, í˜¹ì€ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤ëŠ” í† ìŠ¤íŠ¸ ë©”ì„¸ì§€ë¥¼ ë„ìš´ë‹¤ë˜ì§€ í•˜ëŠ” ë“±ì˜ ì²˜ë¦¬ ë˜í•œ ë™ì¼í•˜ê¸°ë„ í•˜ë‹¤.
ğŸ§ ì´ ë•Œ ì–´ë–»ê²Œ ì²˜ë¦¬ë¥¼ í•´ ì£¼ì–´ì•¼ í• ê¹Œ?
ğŸ‘‰ ë‚˜ëŠ” ê¹€ì¢…ê¶Œë‹˜ì˜ ë¸”ë¡œê·¸ë¥¼ ì°¸ê³ í•´ì„œ, ëª¨ì•¼ í†µì‹ ì„ í•œ í›„ì˜ resultë¥¼, errorì½”ë“œì— ëŒ€í•œ ì²˜ë¦¬ì— ë„£ì–´ì£¼ëŠ” í•¨ìˆ˜ì˜ íŒŒë¼ë¯¸í„°ë¡œ ë„£ì–´ ì£¼ì—ˆë‹¤.
(ğŸ”–ì°¸ê³ : https://ios-development.tistory.com/663)

```swift
// QueueAPIService.swift
static private let provider = MoyaProvider<QueueService>()

static func requestFindHobbyFriends(param: QueueRequest, completion: @escaping (Friends?, Int?) -> Void) {
        
        provider.request(.requestFindHobbyFriends(param: param)) { result in
            switch ResponseData<Friends>.processJSONResponse(result) {
            case .success(let model):
                return completion(model, nil)
            case .failure(let error):
                return completion(nil, error)
            }
        }
}

// repeatedErrorHandling.swift
struct ResponseData<Model: Codable> {
    struct CommonResponse: Codable {
        let result: Model
    }
    
	static func processJSONResponse(_ result: Result<Response, MoyaError>) -> Result<Model?, Int> {
        switch result {
        
        // ì´ ì˜ˆì‹œëŠ” JSONì„ Decodeí•˜ëŠ” ê²½ìš°ì˜ í•¨ìˆ˜. ë§Œì•½ ì´ëŸ° ê³¼ì •ì´ í•„ìš”í•˜ì§€ ì•Šë‹¤ë©´ ìƒëµí•´ ì£¼ì–´ë„ ëœë‹¤.
        case .success(let response):
            do {
                let model = try JSONDecoder().decode(Model.self, from: response.data)
                return .success(model)
            } catch {
            	// decodable Errorë¥¼ ì˜ë¯¸í•˜ëŠ” ë¬´ì–¸ê°€ë¥¼ ë°˜í™˜í•˜ê¸°
                return .failure(600)
            }
            
        case .failure(let error):
            let statusCode = error.response?.statusCode
            print("API Error Code: \(error.errorCode)")
            
            switch statusCode {
                
            // enum APIErrorCodeì„ í†µí•´ ë¯¸ë¦¬ ErrorCodeì— ëŒ€í•´ ì •ì˜í•¨
            case APIErrorCode.unAuthorized.rawValue:
                // firebase í† í° ì—ëŸ¬ê°€ ë‚¬ì„ ë•Œ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
                return .failure(statusCode)
                
            case APIErrorCode.notAcceptable.rawValue:
                // ë¯¸ê°€ì…íšŒì›ì¼ ë•Œ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
                return .failure(statusCode)
                
            case APIErrorCode.internalServerError.rawValue:
                 // ì„œë²„ ì—ëŸ¬ì¼ ë•Œ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
                return .failure(statusCode)
                
            default:
            	// ê·¸ ì™¸ì˜ ê²½ìš°ì—ëŠ” errorì½”ë“œë¥¼ ë¦¬í„´í•œë‹¤.
                return .failure(statusCode!) ?? 501)
            }
        }
    }
}
```
- ìœ„ì™€ ê°™ì´ ë°˜ë³µë˜ëŠ” ì˜¤ë¥˜ì— ëŒ€ì‘í•  ìˆ˜ ìˆë„ë¡ ì‘ì„±í•´ ì¤€ë‹¤. ê° pathì— ë”°ë¥¸ ì˜ˆì™¸ì ì¸ ì˜¤ë¥˜ì— ëŒ€í•´ì„œëŠ” defaultë¥¼ í†µí•´ ErrorCodeë¥¼ ë°˜í™˜í•´ ì£¼ì–´ì„œ, ViewModelì—ì„œ ê°œë³„ì ìœ¼ë¡œ ì²˜ë¦¬ë¥¼ í•´ ì£¼ë„ë¡ í–ˆë‹¤.
- ê·¸ë¦¬ê³  JSONê°’ì„ ë³€í™˜í•  í•„ìš”ê°€ì—†ëŠ” ê²½ìš°ì™€, ë³€í™˜í•  í•„ìš”ê°€ ìˆëŠ” ê²½ìš° ë“± ì„±ê³µí•œ ì‘ë‹µê°’ì— ëŒ€í•œ ì²˜ë¦¬ ë˜í•œ ì—¬ëŸ¬ ê°€ì§€ë¡œ ë‚˜ë‰˜ëŠ” ê²½ìš°ë¼ë©´, ìœ„ì˜ íŒŒì¼ì—ì„œ ì—¬ëŸ¬ í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ ì£¼ì–´ì„œ ë¶„ê¸° ì²˜ë¦¬ë¥¼ í–ˆë‹¤.
- ì˜ˆë¥¼ ë“¤ì–´, JSON ë””ì½”ë“œê°€ í•„ìš” ì—†ëŠ” `processResponse`í•¨ìˆ˜ë¥¼ ë§Œë“¤ì—ˆë‹¤ë©´, ì•„ë˜ ì²˜ëŸ¼ ResponseDataì—ì„œ ê·¸ í•¨ìˆ˜ì— ì ‘ê·¼í•˜ë„ë¡ í•´ ì£¼ë©´ ëœë‹¤.
`switch ResponseData<Friends>.processResponse(result) `

<br/>
ë‚˜ì˜ Moyaì‚¬ìš©ê¸°ëŠ” ì—¬ê¸°ê¹Œì§€.. ì‚¬ì‹¤ RxSwiftë¥¼ ì´ìš©í•´ì„œ ì²˜ë¦¬í•˜ëŠ” ì˜ˆì œê°€ Moya ê¹ƒí—ˆë¸Œì— ì˜ ì„¤ëª…ë˜ì–´ ìˆê¸°ë„ í•˜ë‹¤. ì¶”í›„ ë¦¬íŒ©í† ë§ì„ í•˜ë©° RxSwiftë¥¼ ì´ìš©í•´ ì²˜ë¦¬í•˜ëŠ” ê²ƒì— ë„ì „í•´ ë´ì•¼ê² ë‹¤.

ğŸ”– ì°¸ê³ 
- https://github.com/Moya/Moya
- https://github.com/Moya/Moya/blob/master/docs/Examples/Response.md
- https://pooh-footprints.tistory.com/39
- https://velog.io/@dlskawns96/iOS-Moyaë¥¼-ì‚¬ìš©í•œ-ë„¤íŠ¸ì›Œí‚¹-Swift-Http-í†µì‹ 
- https://ios-development.tistory.com/663
